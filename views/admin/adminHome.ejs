<style>
.dashboard-card {
  border-radius: 15px;
  transition: all 0.3s;
  overflow: hidden;
}
.dashboard-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.15) !important;
}
.bg-egac-green {
  background: linear-gradient(135deg, #7cb342 0%, #558b2f 100%);
}
.bg-egac-light-green {
  background: linear-gradient(135deg, #689f38 0%, #558b2f 100%);
}
.bg-egac-orange {
  background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
}
.card-icon {
  font-size: 3rem;
  opacity: 0.3;
  position: absolute;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
}
.alert-item {
  border-left: 4px solid #e53935;
  padding: 12px;
  margin-bottom: 10px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  transition: all 0.2s;
}
.alert-item:hover {
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transform: translateX(5px);
}
</style>

<div class="container-fluid mt-4">
  <!-- Cards de Resumo -->
  <div class="row g-3 mb-4">
    <div class="col-xl-4 col-md-6">
      <div class="card border-0 shadow-sm dashboard-card bg-egac-green text-white position-relative">
        <div class="card-body p-4">
          <h6 class="mb-1 text-white-50 text-uppercase" style="font-size: 0.75rem; letter-spacing: 1px;">Vendas Totais</h6>
          <h2 class="mb-0 fw-bold" id="totalVendas">R$ 0,00</h2>
          <i class="bi bi-cart-check card-icon"></i>
        </div>
      </div>
    </div>

    <div class="col-xl-4 col-md-6">
      <div class="card border-0 shadow-sm dashboard-card bg-egac-light-green text-white position-relative">
        <div class="card-body p-4">
          <h6 class="mb-1 text-white-50 text-uppercase" style="font-size: 0.75rem; letter-spacing: 1px;">Clientes</h6>
          <h2 class="mb-0 fw-bold" id="totalClientes">0</h2>
          <i class="bi bi-people card-icon"></i>
        </div>
      </div>
    </div>

    <div class="col-xl-4 col-md-6">
      <div class="card border-0 shadow-sm dashboard-card bg-egac-orange text-white position-relative">
        <div class="card-body p-4">
          <h6 class="mb-1 text-white-50 text-uppercase" style="font-size: 0.75rem; letter-spacing: 1px;">Estoque Baixo</h6>
          <h2 class="mb-0 fw-bold" id="produtosBaixo">0</h2>
          <i class="bi bi-exclamation-triangle card-icon"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos e Alertas -->
  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-bar-chart-fill text-success me-2"></i>Vendas por Período</h5>
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-outline-success active" onclick="carregarVendas('dia')">Dia</button>
              <button type="button" class="btn btn-outline-success" onclick="carregarVendas('mes')">Mês</button>
              <button type="button" class="btn btn-outline-success" onclick="carregarVendas('ano')">Ano</button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="graficoVendas" style="min-height: 300px;">
            <canvas id="chartVendas"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0 py-3">
          <h5 class="mb-0"><i class="bi bi-exclamation-circle-fill text-danger me-2"></i>Alertas de Estoque</h5>
        </div>
        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
          <div id="alertasEstoque">
            <div class="text-center text-muted py-4">
              <i class="bi bi-inbox fs-1 d-block mb-2"></i>
              <p>Carregando alertas...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chartVendas;
let periodoAtual = 'dia';

// Carregar dados ao abrir a página
document.addEventListener('DOMContentLoaded', function() {
  carregarResumo();
  carregarVendas('dia');
  carregarAlertasEstoque();
});

// Carregar resumo do dashboard
async function carregarResumo() {
  try {
    const response = await fetch('/admin/dashboard/resumo');
    
    if (!response.ok) {
      throw new Error('Erro ao carregar resumo: ' + response.status);
    }
    
    const data = await response.json();
    console.log('Dados recebidos:', data);
    
    if (data && typeof data.totalVendas !== 'undefined') {
      document.getElementById('totalVendas').textContent = 'R$ ' + parseFloat(data.totalVendas || 0).toFixed(2).replace('.', ',');
    }
    
    if (data && typeof data.totalClientes !== 'undefined') {
      document.getElementById('totalClientes').textContent = parseInt(data.totalClientes || 0);
    }
    
    if (data && typeof data.produtosBaixo !== 'undefined') {
      document.getElementById('produtosBaixo').textContent = parseInt(data.produtosBaixo || 0);
    }
  } catch (error) {
    console.error('Erro ao carregar resumo:', error);
    document.getElementById('totalVendas').textContent = 'R$ 0,00';
    document.getElementById('totalClientes').textContent = '0';
    document.getElementById('produtosBaixo').textContent = '0';
  }
}

// Carregar vendas por período
async function carregarVendas(periodo) {
  periodoAtual = periodo;
  
  // Atualizar botões ativos
  document.querySelectorAll('.btn-group button').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Marcar o botão correto como ativo
  const botoes = document.querySelectorAll('.btn-group button');
  botoes.forEach(btn => {
    if (btn.textContent.toLowerCase() === periodo.toLowerCase()) {
      btn.classList.add('active');
    }
  });
  
  try {
    const response = await fetch('/admin/dashboard/vendas?periodo=' + periodo);
    const data = await response.json();
    
    renderizarGrafico(data);
  } catch (error) {
    console.error('Erro ao carregar vendas:', error);
  }
}

// Renderizar gráfico de vendas
function renderizarGrafico(data) {
  const ctx = document.getElementById('chartVendas').getContext('2d');
  
  if (chartVendas) {
    chartVendas.destroy();
  }
  
  chartVendas = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels || [],
      datasets: [{
        label: 'Vendas (R$)',
        data: data.valores || [],
        backgroundColor: 'rgba(124, 179, 66, 0.1)',
        borderColor: '#7cb342',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#7cb342',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 5,
        pointHoverRadius: 7
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'R$ ' + value.toFixed(0);
            }
          }
        }
      }
    }
  });
}

// Carregar alertas de estoque
async function carregarAlertasEstoque() {
  try {
    const response = await fetch('/admin/dashboard/alertas-estoque');
    const produtos = await response.json();
    
    const container = document.getElementById('alertasEstoque');
    
    if (produtos.length === 0) {
      container.innerHTML = `
        <div class="text-center text-muted py-4">
          <i class="bi bi-check-circle fs-1 d-block mb-2 text-success"></i>
          <p>Nenhum produto com estoque baixo</p>
        </div>
      `;
      return;
    }
    
    let html = '';
    produtos.forEach(produto => {
      html += `
        <div class="alert-item">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${produto.nome}</strong>
              <div class="small text-muted">Estoque: ${produto.estoque} unidades</div>
            </div>
            <span class="badge bg-danger">${produto.estoque}</span>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  } catch (error) {
    console.error('Erro ao carregar alertas de estoque:', error);
    document.getElementById('alertasEstoque').innerHTML = `
      <div class="text-center text-danger py-4">
        <i class="bi bi-exclamation-circle fs-1 d-block mb-2"></i>
        <p>Erro ao carregar alertas</p>
      </div>
    `;
  }
}
</script>
