<script src="/js/compras/detalhes.js" defer></script>
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <a href="/admin/ordemServicos" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar para Lista de Ordens de Serviço
            </a>
        </div>
    </div>

    <input type="hidden" id="OSId" value="<%=OS.id%>">
    <div class="row">
        <div class="col-md-8">
            <!-- Card de Informações da Compra -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        Ordem de Serviço #<%= OS.id %>   Status: <%= OS.status==0 ? 'A Fazer' : OS.status==1 ? 'Concluída' : 'Recebida' %>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <p class="mb-2"><strong>Data de Abertura:</strong></p>
                            <p><%= new Date(OS.dataAbertura).toLocaleString('pt-BR') %></p>
                        </div>
                        <div class="col-md-3">
                            <p class="mb-2"><strong>Data de Conclusão:</strong></p>
                            <p><%= new Date(OS.dataConclusao).toLocaleString('pt-BR') %></p>
                        </div>
                        <div class="col-md-3">
                            <p class="mb-2"><strong>Serviço:</strong></p>
                            <p><%= OS.nomeServico %></p>
                        </div>
                        <div class="col-md-3">
                            <p class="mb-2"><strong>Funcionário Responsável:</strong></p>
                            <p><%= OS.nomeFuncionario %></p>
                        </div>
                        <div class="col-md-3">
                            <p class="mb-2"><strong>Comentário:</strong></p>
                            <p><%= OS.comentario %></p>
                        </div>
                        <div class="col-md-3">
                            <p class="mb-2"><strong>Valor do Serviço:</strong></p>
                            <p class="text-success fs-4"><strong>R$ <%= parseFloat(OS.precoServico).toFixed(2).replace('.', ',') %></strong></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card de Itens do Pedido -->
            <% if(OS.status > 0){ %>
            <div class="card ">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        Insumos Utilizados na Ordem de Serviço
                    </h5>
                </div>
                <div class="card-body p-0 mb-3">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center">Produto</th>
                                    <th class="text-center">Quantidade</th>
                                    <th class="text-end">Valor Unit.</th>
                                    <th class="text-end">Valor Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% for(let i=0; i<listaItensUsados.length; i++) {%>
                                    <tr>
                                        
                                        <td class="text-center"><%=listaItensUsados[i].nomeProd%></td>
                                        <td class="text-center"><%= listaItensUsados[i].qtd %></td>
                                        <td class="text-end">R$ <%= parseFloat(listaItensUsados[i].precoUni).toFixed(2).replace('.', ',') %></td>
                                        <td class="text-end"><strong>R$ <%= parseFloat(listaItensUsados[i].qtd * listaItensUsados[i].precoUni).toFixed(2).replace('.', ',') %></strong></td>
                                    </tr>
                                <%}%>
                            </tbody>
                            <!-- <tfoot class="table-light">
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Total da Compra:</strong></td>
                                    <td class="text-end"><strong class="text-success fs-5">R$ <%#= parseFloat(compraModel.valorTotal).toFixed(2).replace('.', ',') %></strong></td>
                                </tr>
                            </tfoot> -->
                        </table>
                    </div>
                </div>
            </div>
            <div class="card ">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        SubItens do Serviço
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center">Nome</th>
                                    <th class="text-center">Funcionário</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% for(let i=0; i<listaSubItens.length; i++) {%>
                                    <tr>
                                        
                                        <td class="text-center"><%=listaSubItens[i].nome%></td>
                                        <td class="text-center"><%= listaSubItens[i].nomeFunc %></td>
                                    </tr>
                                <%}%>
                            </tbody>
                            <!-- <tfoot class="table-light">
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Total da Compra:</strong></td>
                                    <td class="text-end"><strong class="text-success fs-5">R$ <%#= parseFloat(compraModel.valorTotal).toFixed(2).replace('.', ',') %></strong></td>
                                </tr>
                            </tfoot> -->
                        </table>
                    </div>
                </div>
            </div><%}%>
        </div>

        <!-- Sidebar com Dados do Cliente -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        Dados do Equipamento Agrícola
                    </h5>
                </div>
                <div class="card-body">
                        <div class="mb-3">
                            <p class="mb-1"><strong>Nome:</strong></p>
                            <p ><%= EqAg.nome %></p>
                        </div>
                        <div class="mb-3">
                            <p class="mb-1"><strong>Marca:</strong></p>
                            <p ><%= EqAg.marca_nome %></p>
                        </div>
                        <div class="mb-3">
                            <p class="mb-1"><strong>Categoria:</strong></p>
                            <p ><%= EqAg.categoria_nome %></p>
                        </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        Dados do Cliente
                    </h5>
                </div>
                <div class="card-body">
                    <% if(cliente.nome) { %>
                        <div class="mb-3">
                            <p class="mb-1"><strong>Nome:</strong></p>
                            <p ><%= cliente.nome %></p>
                        </div>
                        <% if(cliente.cnpj) { %>
                        <div class="mb-3">
                            <p class="mb-1"><strong>CNPJ:</strong></p>
                            <p ><%= cliente.cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5') %></p>
                        </div>
                        <% } %>
                        <% if(cliente.cpf) { %>
                        <div class="mb-3">
                            <p class="mb-1"><strong>CPF:</strong></p>
                            <p ><%= cliente.cpf.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4') %></p>
                        </div>
                        <% } %>
                        <div class="mb-3">
                            <p class="mb-1"><strong>Telefone:</strong></p>
                            <p ><%= cliente.telefone.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3')%></p>
                        </div>
                    <%}%>
                </div>
            </div>
        </div>
    </div>
</div>
